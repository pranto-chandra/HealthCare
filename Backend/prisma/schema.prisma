generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  PATIENT
  DOCTOR
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum Division {
  DHAKA
  CHITTAGONG
  RAJSHAHI
  KHULNA
  BARISHAL
  SYLHET
  RANGPUR
  MYMENSINGH
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum AppointmentType {
  ONLINE
  OFFLINE
}

// Core User Table
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  role              Role
  isProfileComplete Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  adminProfile   AdminProfile?
  patientProfile PatientProfile?
  doctorProfile  DoctorProfile?
}

// Admin Profile
model AdminProfile {
  id     String @id @default(uuid())
  userId String @unique
  name   String
  phone  String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Patient Profile
model PatientProfile {
  id              String     @id @default(uuid())
  userId          String     @unique
  name            String
  phone           String
  dateOfBirth     DateTime
  gender          Gender
  bloodGroup      BloodGroup

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  prescriptions   Prescription[] @relation("PatientPrescriptions")
  labTests        LabTest[]
  medicalHistory  MedicalHistory[]
  healthRecords   HealthMonitoring[]
}

// Doctor Profile
model DoctorProfile {
  id              String             @id @default(uuid())
  userId          String             @unique
  name            String
  phone           String
  dateOfBirth     DateTime
  locationDiv     Division
  licenseNumber   String             @unique
  consultationFee Decimal
  experienceYears Int                @default(0)

  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  prescriptions   Prescription[]     @relation("DoctorPrescriptions")
  labTests        LabTest[]
  medicalHistory  MedicalHistory[]
  degrees         DoctorDegree[]
  specialties     DoctorSpeciality[]
}

// Degree Master Table
model Degree {
  id           String         @id @default(uuid())
  name         String         @unique
  institution  String?
  country      String?

  doctors      DoctorDegree[]
}

// Doctor-Degree Junction
model DoctorDegree {
  doctorId    String
  degreeId    String
  passingYear Int

  doctor      DoctorProfile @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  degree      Degree        @relation(fields: [degreeId], references: [id], onDelete: Cascade)

  @@id([doctorId, degreeId])
}

// Speciality Master Table
model Speciality {
  id          String             @id @default(uuid())
  name        String             @unique
  description String?

  doctors     DoctorSpeciality[]
}

// Doctor-Speciality Junction
model DoctorSpeciality {
  doctorId     String
  specialityId String

  doctor       DoctorProfile @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  speciality   Speciality    @relation(fields: [specialityId], references: [id], onDelete: Cascade)

  @@id([doctorId, specialityId])
}

// Appointment (Central Hub)
model Appointment {
  id              String            @id @default(uuid())
  patientId       String
  doctorId        String
  scheduledAt     DateTime
  status          AppointmentStatus @default(PENDING)
  type            AppointmentType
  symptoms        String?           @db.Text
  diagnosis       String?           @db.Text
  notes           String?           @db.Text
  bookedAt        DateTime          @default(now())
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  // Relations
  patient         PatientProfile    @relation(fields: [patientId], references: [id])
  doctor          DoctorProfile     @relation(fields: [doctorId], references: [id])
  prescription    Prescription?
  labTests        LabTest[]

  @@index([patientId, scheduledAt])
  @@index([doctorId, scheduledAt])
  @@index([status])
}

// Prescription
model Prescription {
  id                String             @id @default(uuid())
  appointmentId     String             @unique
  patientId         String
  doctorId          String
  prescriptionDate  DateTime
  diagnosis         String
  description       String             @db.Text
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  // Relations
  appointment       Appointment        @relation(fields: [appointmentId], references: [id])
  doctor            DoctorProfile      @relation("DoctorPrescriptions", fields: [doctorId], references: [id])
  patient           PatientProfile     @relation("PatientPrescriptions", fields: [patientId], references: [id])
  medications       MedicationTracking[]
}

// Medication Tracking (simplified - no reminders)
model MedicationTracking {
  id              String       @id @default(uuid())
  prescriptionId  String
  medicationName  String
  dosage          String
  frequency       String
  duration        String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  prescription    Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
}

// Lab Test
model LabTest {
  id              String         @id @default(uuid())
  patientId       String
  doctorId        String
  appointmentId   String?
  testName        String
  testDate        DateTime
  description     String         @db.Text
  resultFile      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  patient         PatientProfile @relation(fields: [patientId], references: [id])
  doctor          DoctorProfile  @relation(fields: [doctorId], references: [id])
  appointment     Appointment?   @relation(fields: [appointmentId], references: [id])
}

// Medical History
model MedicalHistory {
  id          String         @id @default(uuid())
  patientId   String
  doctorId    String
  diagnosis   String
  treatment   String         @db.Text
  allergies   String?        @db.Text
  symptoms    String         @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  patient     PatientProfile @relation(fields: [patientId], references: [id])
  doctor      DoctorProfile  @relation(fields: [doctorId], references: [id])
}

// Health Monitoring (Patient self-tracking)
model HealthMonitoring {
  id            String         @id @default(uuid())
  patientId     String
  heartRate     Int?
  temperature   Decimal?
  weight        Decimal?
  bloodPressure String?
  recordDate    DateTime
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  patient       PatientProfile @relation(fields: [patientId], references: [id])
}